<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>TERMINAL_WEATHER_V4</title>
    <style>
        /* --- V4.0: ç›£æ§è­¦å ±ç‰ˆ --- */
        :root {
            --bg-color: #000000;
            --weather-color: #00E1FF;
            --weather-dim: #006064;    
            --quake-color: #FF4500;
            --quake-dim: #8B2500;
            --alert-bg: #330000;      
        }

        body {
            background-color: var(--bg-color);
            color: var(--weather-color);
            font-family: "Courier New", Courier, monospace;
            margin: 0; padding: 15px;
            font-size: 16px; line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: background-color 0.2s;
            padding-bottom: 60px;
        }

        /* è­¦å ±æ™‚çš„èƒŒæ™¯é–ƒçˆç‰¹æ•ˆ */
        body.alarm-active { animation: red-flash 1s infinite; }
        @keyframes red-flash {
            0% { background-color: var(--bg-color); }
            50% { background-color: var(--alert-bg); }
            100% { background-color: var(--bg-color); }
        }

        a { text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }

        header {
            border-bottom: 2px dashed var(--weather-color);
            padding-bottom: 10px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        h1 { font-size: 1.2rem; margin: 0; }
        
        /* ç³»çµ±ç‹€æ…‹ */
        .sys-info { font-size: 0.7rem; color: var(--weather-dim); text-align: right; }
        .monitor-badge {
            display: inline-block; font-size: 0.7rem; padding: 2px 6px; 
            border: 1px solid #333; color: #555; margin-top: 5px; transition: all 0.3s;
        }
        .monitor-active {
            border-color: #00FF00; color: #00FF00;
            box-shadow: 0 0 8px rgba(0,255,0,0.2);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.6;} 100% {opacity:1;} }

        /* --- æ§åˆ¶æŒ‰éˆ•å€ --- */
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn {
            flex: 1; padding: 12px;
            background: #111; color: var(--weather-dim);
            border: 1px dashed var(--weather-dim);
            font-family: inherit; font-size: 0.9rem; cursor: pointer;
            text-transform: uppercase;
        }
        .btn:active { background: #222; }
        /* å•Ÿå‹•å¾Œçš„æŒ‰éˆ•æ¨£å¼ */
        .btn-on { border-color: #00FF00; color: #00FF00; background: rgba(0,20,0,0.3); }

        /* --- åœ°éœ‡è­¦å ±å€ --- */
        #quakeArea { 
            margin-bottom: 20px; display: none; cursor: pointer;
            transition: transform 0.1s;
        }
        .quake-card {
            display: block; border: 2px solid var(--quake-color); color: var(--quake-color);
            padding: 15px; position: relative;
            background: rgba(50, 10, 0, 0.2); box-shadow: 0 0 8px rgba(255, 69, 0, 0.2);
        }
        .quake-card:active { transform: scale(0.98); background: rgba(80, 20, 0, 0.3); }
        .quake-card::before {
            content: "[ âš ï¸ SEISMIC_ALERT // TAP FOR MAP ]";
            position: absolute; top: -10px; left: 10px;
            background: var(--bg-color); padding: 0 5px; font-weight: bold; font-size: 0.8rem;
            border: 1px solid var(--quake-color);
        }
        .quake-card::after { content: "â†—"; position: absolute; top: 5px; right: 10px; font-size: 1.5rem; opacity: 0.5; }
        .quake-main { font-size: 1.3rem; font-weight: bold; margin: 8px 0; }
        .quake-details {
            font-size: 0.95rem; opacity: 0.9; margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed var(--quake-dim); line-height: 1.6; white-space: pre-wrap;
        }
        .alert-blink { animation: rapid-blink 1.5s infinite; }
        @keyframes rapid-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* --- é¸å–®èˆ‡å¤©æ°£ --- */
        .control-group { margin-bottom: 15px; }
        .select-row { display: flex; gap: 10px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 3px; color: var(--weather-dim); }
        select {
            background-color: #051a24; color: var(--weather-color);
            border: 1px solid var(--weather-color); padding: 10px; width: 100%;
            font-family: inherit; font-size: 1rem; border-radius: 0; outline: none; -webkit-appearance: none; 
        }
        .location-header {
            font-size: 1.1rem; border-left: 4px solid var(--weather-color);
            padding-left: 10px; margin: 20px 0 10px 0; color: #fff;
        }
        .forecast-card {
            border: 1px solid var(--weather-dim); padding: 12px; margin-bottom: 12px; position: relative;
        }
        .forecast-card::before {
            content: attr(data-label); position: absolute; top: -10px; right: 10px;
            background: var(--bg-color); color: var(--weather-dim); padding: 0 5px; font-size: 0.7rem;
        }
        .time-badge {
            display: inline-block; background: var(--weather-dim);
            color: #000; padding: 1px 5px; font-size: 0.8rem; font-weight: bold;
        }
        .weather-main { font-size: 1.3rem; font-weight: bold; margin: 5px 0; }
        .details {
            font-size: 0.95rem; color: #B2EBF2; margin-top: 5px; padding-left: 8px;
            border-left: 1px solid var(--weather-dim);
        }
        .highlight { color: #FFF; font-weight: bold; }
        footer {
            margin-top: 30px; font-size: 0.7rem; color: var(--weather-dim);
            text-align: center; border-top: 1px solid #1A4D66; padding-top: 10px;
        }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .error-msg { color: #FF5555; border: 1px solid #FF5555; padding: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <header>
        <h1>> WEATHER_OS_V4</h1>
        <div class="sys-info">
            SYSTEM: ONLINE<br>
            <span id="monitorStatus" class="monitor-badge">AUTO-SCAN: OFF</span>
        </div>
    </header>

    <div class="btn-group">
        <button id="enableBtn" class="btn" onclick="startMonitor()">ğŸ”Š å•Ÿå‹•ç›£æ§</button>
        <button class="btn" onclick="testAlert()">ğŸš¨ æ¸¬è©¦è­¦å ±</button>
    </div>

    <a id="quakeArea" class="quake-card" href="#" target="_blank"></a>

    <div class="control-group">
        <div class="select-row">
            <div style="flex:1">
                <label>SECTOR (CITY)</label>
                <select id="citySelect"><option>LOADING...</option></select>
            </div>
            <div style="flex:1">
                <label>SUB-SECTOR (DIST)</label>
                <select id="distSelect"><option>WAITING...</option></select>
            </div>
        </div>
    </div>

    <div id="displayArea">
        <div class="blink" style="color:var(--weather-dim)">INITIALIZING SYSTEM...</div>
    </div>

    <footer>
        DATA: CWA API | REFRESH: 60s<br>
        UID: ...BEDC3575
    </footer>

    <script>
        const API_KEY = 'CWA-30E05081-14C2-4DAE-831E-2796BEDC3575';
        
        // è®Šæ•¸
        let lastQuakeNo = localStorage.getItem('lastQuakeNo') || "";
        let isMonitorActive = false;
        let autoScanTimer = null;
        
        // éŸ³æ•ˆç³»çµ±
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = new AudioContext();

        const CITY_API_MAP = {
            "å®œè˜­ç¸£": "F-D0047-001", "æ¡ƒåœ’å¸‚": "F-D0047-005", "æ–°ç«¹ç¸£": "F-D0047-009",
            "è‹—æ —ç¸£": "F-D0047-013", "å½°åŒ–ç¸£": "F-D0047-017", "å—æŠ•ç¸£": "F-D0047-021",
            "é›²æ—ç¸£": "F-D0047-025", "å˜‰ç¾©ç¸£": "F-D0047-029", "å±æ±ç¸£": "F-D0047-033",
            "è‡ºæ±ç¸£": "F-D0047-037", "èŠ±è“®ç¸£": "F-D0047-041", "æ¾æ¹–ç¸£": "F-D0047-045",
            "åŸºéš†å¸‚": "F-D0047-049", "æ–°ç«¹å¸‚": "F-D0047-053", "å˜‰ç¾©å¸‚": "F-D0047-057",
            "è‡ºåŒ—å¸‚": "F-D0047-061", "é«˜é›„å¸‚": "F-D0047-065", "æ–°åŒ—å¸‚": "F-D0047-069",
            "è‡ºä¸­å¸‚": "F-D0047-073", "è‡ºå—å¸‚": "F-D0047-077", "é€£æ±Ÿç¸£": "F-D0047-081",
            "é‡‘é–€ç¸£": "F-D0047-085"
        };
        const CITY_ORDER = [
            "åŸºéš†å¸‚", "è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", 
            "è‡ºä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "è‡ºå—å¸‚", 
            "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"
        ];

        const citySelect = document.getElementById('citySelect');
        const distSelect = document.getElementById('distSelect');
        const displayEl = document.getElementById('displayArea');
        const quakeEl = document.getElementById('quakeArea');
        const monitorStatus = document.getElementById('monitorStatus');
        const enableBtn = document.getElementById('enableBtn');

        // --- 1. å•Ÿå‹•ç›£æ§ (é—œéµï¼šè§£é–éŸ³æ•ˆèˆ‡é€šçŸ¥) ---
        function startMonitor() {
            if(isMonitorActive) return;

            // A. è«‹æ±‚é€šçŸ¥æ¬Šé™
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }

            // B. è§£é–ç€è¦½å™¨éŸ³æ•ˆ (å¿…é ˆåœ¨é»æ“Šäº‹ä»¶ä¸­åŸ·è¡Œ)
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playBeep(0); // æ’­æ”¾ä¸€å€‹ç„¡è²æ³¢ï¼Œç¢ºä¿éŸ³è¨Šé€šé“é–‹å•Ÿ

            // C. ä»‹é¢æ›´æ–°
            isMonitorActive = true;
            enableBtn.classList.add('btn-on');
            enableBtn.innerText = ">> ç›£æ§ä¸­ (æ¯60ç§’) <<";
            monitorStatus.classList.add('monitor-active');
            monitorStatus.innerText = "AUTO-SCAN: ACTIVE";

            // D. å•Ÿå‹•å®šæ™‚å™¨ (åŠ å…¥éš¨æ©Ÿæ•¸é˜²æ­¢å¿«å–)
            fetchQuake(true); // ç«‹å³æª¢æŸ¥
            autoScanTimer = setInterval(() => {
                fetchQuake(true);
            }, 60000); // 60ç§’
        }

        // --- 2. æ¸¬è©¦è­¦å ± ---
        function testAlert() {
            // æ¸¬è©¦æ™‚ä¹Ÿå˜—è©¦è§£é–éŸ³æ•ˆ
            if (audioCtx.state === 'suspended') audioCtx.resume();
            triggerAlert({
                EarthquakeMagnitude: { MagnitudeValue: "TEST" },
                Epicenter: { Location: "æ¸¬è©¦è­¦å ±" }
            }, "é€™æ˜¯ä¸€å‰‡æ¸¬è©¦ç”¨çš„åœ°éœ‡è­¦å ±ï¼Œç¢ºèªéŸ³æ•ˆèˆ‡é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚");
        }

        // --- 3. ç™¼å‡ºè­¦å ± (è²éŸ³+é€šçŸ¥+è¦–è¦º) ---
        function triggerAlert(info, content) {
            // éŸ³æ•ˆ (å—¶ä¸‰è²)
            playBeep(1);
            setTimeout(() => playBeep(1), 600);
            setTimeout(() => playBeep(1), 1200);

            // ç³»çµ±é€šçŸ¥
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`âš ï¸ åœ°éœ‡è­¦å ± M${info.EarthquakeMagnitude.MagnitudeValue}`, {
                    body: `${info.Epicenter.Location}\n${content.substring(0,30)}...`,
                    icon: 'https://www.cwa.gov.tw/favicon.ico'
                });
            }

            // è¦–è¦ºé–ƒçˆ
            document.body.classList.add('alarm-active');
            setTimeout(() => document.body.classList.remove('alarm-active'), 5000);
        }

        // --- 4. ç”¢ç”Ÿé›»å­å—¶å—¶è² (Web Audio API) ---
        function playBeep(vol) {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = "square"; // æ–¹æ³¢æ›´æœ‰è­¦å ±æ„Ÿ
                osc.frequency.setValueAtTime(880, audioCtx.currentTime); // 880Hz
                osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.3);

                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } catch(e) { console.error(e); }
        }

        // --- åˆå§‹åŒ–èˆ‡å¤©æ°£ ---
        async function init() {
            citySelect.innerHTML = '';
            CITY_ORDER.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.text = c;
                citySelect.appendChild(opt);
            });

            const savedCity = localStorage.getItem('lastCity') || "è‡ºåŒ—å¸‚";
            const savedDist = localStorage.getItem('lastDist');
            if (CITY_ORDER.includes(savedCity)) citySelect.value = savedCity;

            // åˆæ¬¡åŸ·è¡Œä¸ç™¼è­¦å ±
            fetchQuake(false); 
            await loadCityData(citySelect.value, savedDist);
            
            citySelect.addEventListener('change', (e) => loadCityData(e.target.value));
            distSelect.addEventListener('change', (e) => renderWeather(e.target.value));
        }

        // --- æŠ“åœ°éœ‡ ---
        async function fetchQuake(isMonitorMode) {
            try {
                // é‡é»ï¼šåŠ ä¸Š t=æ™‚é–“æˆ³è¨˜ï¼Œå¼·åˆ¶ç€è¦½å™¨æŠ“æ–°è³‡æ–™ï¼Œä¸è¦ç”¨å¿«å–
                const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=${API_KEY}&limit=1&format=JSON&t=${new Date().getTime()}`);
                const data = await res.json();
                
                if (data.records.Earthquake && data.records.Earthquake.length > 0) {
                    const q = data.records.Earthquake[0];
                    const info = q.EarthquakeInfo;
                    const currentNo = q.EarthquakeNo;

                    // æ¸²æŸ“
                    renderQuakeHTML(q);

                    // åˆ¤æ–·æ˜¯å¦ç‚ºæ–°åœ°éœ‡ (ç·¨è™Ÿè®Šæ›´)
                    if (isMonitorMode && lastQuakeNo && currentNo !== lastQuakeNo) {
                        triggerAlert(info, q.ReportContent);
                    }
                    
                    lastQuakeNo = currentNo;
                    localStorage.setItem('lastQuakeNo', currentNo);
                }
            } catch(e) { console.warn("Quake fetch skipped", e); }
        }

        function renderQuakeHTML(q) {
            const info = q.EarthquakeInfo;
            const time = new Date(info.OriginTime).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
            const webUrl = q.Web || "https://www.cwa.gov.tw/V8/C/E/index.html";
            
            quakeEl.href = webUrl;
            quakeEl.innerHTML = `
                <div style="font-size:0.8rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                    <span class="alert-blink">âš ï¸ LATEST REPORT</span>
                    <span>${time}</span>
                </div>
                <div class="quake-main">M${info.EarthquakeMagnitude.MagnitudeValue} | Depth ${info.FocalDepth}km</div>
                <div class="quake-details">${q.ReportContent}</div>`;
            quakeEl.style.display = 'block';
        }

        // --- å¤©æ°£åŠŸèƒ½ ---
        async function loadCityData(cityName, targetDist = null) {
            const dataId = CITY_API_MAP[cityName];
            if(!dataId) return;
            // ç›£æ§æ¨¡å¼ä¸‹ä¸è¦ä¸€ç›´é¡¯ç¤º Loading é–ƒçˆ
            if(!isMonitorActive) displayEl.innerHTML = `<div class="blink">DOWNLOADING...</div>`;
            
            try {
                const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/${dataId}?Authorization=${API_KEY}&format=JSON&elementName=Wx,T,PoP12h,AT`);
                const data = await res.json();
                if (data.success === "true") {
                    currentCityData = data.records.locations[0].location;
                    populateDistricts(cityName, targetDist);
                }
            } catch (err) { displayEl.innerHTML = "DATA ERROR"; }
        }

        function populateDistricts(cityName, targetDist) {
            distSelect.innerHTML = '';
            const districts = currentCityData.map(loc => loc.locationName);
            districts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.text = d;
                distSelect.appendChild(opt);
            });
            if (targetDist && districts.includes(targetDist)) distSelect.value = targetDist;
            else distSelect.selectedIndex = 0;
            renderWeather(distSelect.value);
            localStorage.setItem('lastCity', cityName);
        }

        function renderWeather(distName) {
            localStorage.setItem('lastDist', distName);
            const location = currentCityData.find(l => l.locationName === distName);
            if (!location) return;

            const elements = {};
            location.weatherElement.forEach(e => { elements[e.elementName] = e.time; });

            let html = `<div class="location-header">> ${citySelect.value} ${distName}</div>`;
            const loopLimit = Math.min(3, elements['Wx'] ? elements['Wx'].length : 0);

            for(let i=0; i<loopLimit; i++) {
                const wxTime = elements['Wx'][i];
                const startTime = new Date(wxTime.startTime);
                const d = startTime.getDate().toString().padStart(2,'0');
                const h = startTime.getHours().toString().padStart(2,'0');
                const m = startTime.getMinutes().toString().padStart(2,'0');
                
                const wx = elements['Wx'][i].elementValue[0].value;
                const temp = elements['T'][i].elementValue[0].value;
                const feel = elements['AT'][i].elementValue[0].value;
                
                let pop = "0"; 
                if (elements['PoP12h']) {
                    const popData = elements['PoP12h'].find(p => {
                        const pStart = new Date(p.startTime);
                        const pEnd = new Date(p.endTime);
                        return (startTime >= pStart && startTime < pEnd) || (pStart >= startTime && pStart < new Date(wxTime.endTime));
                    });
                    pop = popData ? popData.elementValue[0].value : "-";
                    if(pop === " " || pop === "") pop = "0"; 
                }

                html += `
                <div class="forecast-card" data-label="+${i*3}HR">
                    <div class="time-badge">${d}æ—¥ ${h}:${m} èµ·</div>
                    <div class="weather-main">${wx}</div>
                    <div class="details">
                        æº«åº¦: <span class="highlight">${temp}Â°C</span> (é«”æ„Ÿ ${feel}Â°C)<br>
                        é™é›¨æ©Ÿç‡: <span class="highlight">${pop}%</span>
                    </div>
                </div>`;
            }
            displayEl.innerHTML = html;
        }

        init();
    </script>
</body>
</html>
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        h1 { font-size: 1.2rem; margin: 0; }
        .sys-info { font-size: 0.7rem; color: var(--weather-dim); text-align: right; }

        /* --- åœ°éœ‡è­¦å ± (æŒ‰éˆ•åŒ–) --- */
        /* é è¨­éš±è—ï¼Œæœ‰è³‡æ–™æ‰é¡¯ç¤ºï¼Œä¸¦è¨­å®šç‚ºå€å¡Šé€£çµ */
        #quakeArea { 
            margin-bottom: 20px; 
            display: none; 
        }
        
        .quake-card {
            border: 2px solid var(--quake-color);
            color: var(--quake-color);
            padding: 15px;
            position: relative;
            background: rgba(50, 10, 0, 0.2);
            box-shadow: 0 0 8px rgba(255, 69, 0, 0.2);
            
            /* äº’å‹•æ‰‹æ„Ÿè¨­å®š */
            cursor: pointer;
            transition: all 0.1s ease;
            display: block; 
        }

        /* æŒ‰ä¸‹æ™‚çš„è¦–è¦ºå›é¥‹ */
        .quake-card:active {
            transform: scale(0.98);
            background: rgba(100, 20, 0, 0.4);
        }

        .quake-card::before {
            content: "[ âš ï¸ SEISMIC_ALERT // TAP FOR MAP ]";
            position: absolute;
            top: -10px; left: 10px;
            background: var(--bg-color);
            padding: 0 5px; font-weight: bold; font-size: 0.8rem;
            border: 1px solid var(--quake-color);
        }
        
        /* å³ä¸Šè§’å¤–é€£åœ–ç¤º */
        .quake-card::after {
            content: "â†—";
            position: absolute;
            top: 5px; right: 10px;
            font-size: 1.5rem;
            opacity: 0.5;
        }

        .quake-main { font-size: 1.3rem; font-weight: bold; margin: 8px 0; }
        
        /* å®Œæ•´å ±å‘Šæ–‡å­—å€ */
        .quake-details {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--quake-dim);
            line-height: 1.6;
            white-space: pre-wrap; /* é—œéµï¼šä¿ç•™æ›è¡Œæ ¼å¼ */
        }
        
        .alert-blink { animation: rapid-blink 1.5s infinite; }
        @keyframes rapid-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* --- é¸å–®å€ --- */
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 3px; color: var(--weather-dim); }
        .select-row { display: flex; gap: 10px; }
        
        select {
            background-color: #051a24;
            color: var(--weather-color);
            border: 1px solid var(--weather-color);
            padding: 10px;
            width: 100%;
            font-family: inherit; font-size: 1rem;
            border-radius: 0; outline: none; -webkit-appearance: none; 
        }

        /* --- å¤©æ°£å€ --- */
        .location-header {
            font-size: 1.1rem;
            border-left: 4px solid var(--weather-color);
            padding-left: 10px;
            margin: 20px 0 10px 0;
            color: #fff;
        }

        .forecast-card {
            border: 1px solid var(--weather-dim);
            padding: 12px; margin-bottom: 12px; position: relative;
        }
        .forecast-card::before {
            content: attr(data-label);
            position: absolute; top: -10px; right: 10px;
            background: var(--bg-color); color: var(--weather-dim);
            padding: 0 5px; font-size: 0.7rem;
        }

        .time-badge {
            display: inline-block; background: var(--weather-dim);
            color: #000; padding: 1px 5px; font-size: 0.8rem; font-weight: bold;
        }
        .weather-main { font-size: 1.3rem; font-weight: bold; margin: 5px 0; }
        .details {
            font-size: 0.95rem; color: #B2EBF2;
            margin-top: 5px; padding-left: 8px;
            border-left: 1px solid var(--weather-dim);
        }
        .highlight { color: #FFF; font-weight: bold; }

        footer {
            margin-top: 30px; font-size: 0.7rem; color: var(--weather-dim);
            text-align: center; border-top: 1px solid #1A4D66; padding-top: 10px;
        }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <header>
        <h1>> WEATHER_OS_V3.1</h1>
        <div class="sys-info">Interactive Mode</div>
    </header>

    <a id="quakeArea" class="quake-card" href="#" target="_blank">
        </a>

    <div class="control-group">
        <div class="select-row">
            <div style="flex:1">
                <label>SECTOR (CITY)</label>
                <select id="citySelect"><option>LOADING...</option></select>
            </div>
            <div style="flex:1">
                <label>SUB-SECTOR (DIST)</label>
                <select id="distSelect"><option>WAITING...</option></select>
            </div>
        </div>
    </div>

    <div id="displayArea">
        <div class="blink" style="color:var(--weather-dim)">INITIALIZING...</div>
    </div>

    <footer>
        DATA: CWA API<br>
        UID: ...BEDC3575
    </footer>

    <script>
        const API_KEY = 'CWA-30E05081-14C2-4DAE-831E-2796BEDC3575';
        
        // é„‰é®å¸‚å€ API ä»£ç¢¼è¡¨
        const CITY_API_MAP = {
            "å®œè˜­ç¸£": "F-D0047-001", "æ¡ƒåœ’å¸‚": "F-D0047-005", "æ–°ç«¹ç¸£": "F-D0047-009",
            "è‹—æ —ç¸£": "F-D0047-013", "å½°åŒ–ç¸£": "F-D0047-017", "å—æŠ•ç¸£": "F-D0047-021",
            "é›²æ—ç¸£": "F-D0047-025", "å˜‰ç¾©ç¸£": "F-D0047-029", "å±æ±ç¸£": "F-D0047-033",
            "è‡ºæ±ç¸£": "F-D0047-037", "èŠ±è“®ç¸£": "F-D0047-041", "æ¾æ¹–ç¸£": "F-D0047-045",
            "åŸºéš†å¸‚": "F-D0047-049", "æ–°ç«¹å¸‚": "F-D0047-053", "å˜‰ç¾©å¸‚": "F-D0047-057",
            "è‡ºåŒ—å¸‚": "F-D0047-061", "é«˜é›„å¸‚": "F-D0047-065", "æ–°åŒ—å¸‚": "F-D0047-069",
            "è‡ºä¸­å¸‚": "F-D0047-073", "è‡ºå—å¸‚": "F-D0047-077", "é€£æ±Ÿç¸£": "F-D0047-081",
            "é‡‘é–€ç¸£": "F-D0047-085"
        };

        const CITY_ORDER = [
            "åŸºéš†å¸‚", "è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", 
            "è‡ºä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "è‡ºå—å¸‚", 
            "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"
        ];

        const citySelect = document.getElementById('citySelect');
        const distSelect = document.getElementById('distSelect');
        const displayEl = document.getElementById('displayArea');
        const quakeEl = document.getElementById('quakeArea');
        let currentCityData = null;

        async function init() {
            // é¸å–®åˆå§‹åŒ–
            citySelect.innerHTML = '';
            CITY_ORDER.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.text = c;
                citySelect.appendChild(opt);
            });

            const savedCity = localStorage.getItem('lastCity') || "è‡ºåŒ—å¸‚";
            const savedDist = localStorage.getItem('lastDist');
            citySelect.value = savedCity;

            // é›™è»ŒåŸ·è¡Œ
            fetchQuake(); 
            await loadCityData(savedCity, savedDist);
            
            citySelect.addEventListener('change', (e) => loadCityData(e.target.value));
            distSelect.addEventListener('change', (e) => renderWeather(e.target.value));
        }

        // --- æ ¸å¿ƒæ›´æ–°ï¼šåœ°éœ‡è³‡è¨Š (å®Œæ•´ç‰ˆ + é€£çµ) ---
        async function fetchQuake() {
            try {
                // æŠ“å–æœ€æ–°æœ‰æ„Ÿåœ°éœ‡
                const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=${API_KEY}&limit=1&format=JSON`);
                const data = await res.json();
                
                if (data.records.Earthquake && data.records.Earthquake.length > 0) {
                    const q = data.records.Earthquake[0];
                    const info = q.EarthquakeInfo;
                    const time = new Date(info.OriginTime).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
                    
                    // 1. è¨­å®šè·³è½‰é€£çµ
                    // å„ªå…ˆä½¿ç”¨ API æä¾›çš„ Web ç¶²å€ (é€šå¸¸æ˜¯è©²åœ°éœ‡çš„å°ˆå±¬é é¢)ï¼Œè‹¥ç„¡å‰‡é€£è‡³åœ°éœ‡é¦–é 
                    const webUrl = q.Web || "https://www.cwa.gov.tw/V8/C/E/index.html";
                    quakeEl.href = webUrl;

                    // 2. é¡¯ç¤ºå®Œæ•´è³‡è¨Š
                    // ä½¿ç”¨ ReportContent é¡¯ç¤ºå®Œæ•´å ±å‘Šï¼ŒCSS å·²è¨­å®šè‡ªå‹•æ›è¡Œ
                    quakeEl.innerHTML = `
                        <div style="font-size:0.8rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                            <span class="alert-blink">âš ï¸ LATEST REPORT</span>
                            <span>${time}</span>
                        </div>
                        <div class="quake-main">M${info.EarthquakeMagnitude.MagnitudeValue} | Depth ${info.FocalDepth}km</div>
                        <div class="quake-details">
                            ${q.ReportContent}
                        </div>`;
                        
                    quakeEl.style.display = 'block'; // é¡¯ç¤ºæŒ‰éˆ•
                }
            } catch(e) { console.error("Quake Error", e); }
        }

        async function loadCityData(cityName, targetDist = null) {
            displayEl.innerHTML = `<div class="blink">DOWNLOADING DATA...</div>`;
            const dataId = CITY_API_MAP[cityName];
            if(!dataId) return;

            const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${dataId}?Authorization=${API_KEY}&format=JSON&elementName=Wx,T,PoP12h,AT`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.success === "true") {
                    currentCityData = data.records.locations[0].location;
                    populateDistricts(cityName, targetDist);
                }
            } catch (err) {
                console.error(err);
                displayEl.innerHTML = "API ERROR";
            }
        }

        function populateDistricts(cityName, targetDist) {
            distSelect.innerHTML = '';
            const districts = currentCityData.map(loc => loc.locationName);
            districts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.text = d;
                distSelect.appendChild(opt);
            });

            if (targetDist && districts.includes(targetDist)) {
                distSelect.value = targetDist;
            } else {
                distSelect.selectedIndex = 0;
            }
            renderWeather(distSelect.value);
            localStorage.setItem('lastCity', cityName);
        }

        function renderWeather(distName) {
            localStorage.setItem('lastDist', distName);
            const location = currentCityData.find(l => l.locationName === distName);
            if (!location) return;

            const elements = {};
            location.weatherElement.forEach(e => { elements[e.elementName] = e.time; });

            let html = `<div class="location-header">> ${citySelect.value} ${distName}</div>`;

            for(let i=0; i<3; i++) {
                const wxTime = elements['Wx'][i];
                const startTime = new Date(wxTime.startTime);
                const timeStr = formatTime(startTime);
                const wx = elements['Wx'][i].elementValue[0].value;
                const temp = elements['T'][i].elementValue[0].value;
                const feel = elements['AT'][i].elementValue[0].value;
                
                let pop = "0"; 
                if (elements['PoP12h']) {
                    const popData = elements['PoP12h'].find(p => {
                        const pStart = new Date(p.startTime);
                        const pEnd = new Date(p.endTime);
                        return startTime >= pStart && startTime < pEnd;
                    });
                    pop = popData ? popData.elementValue[0].value : "-";
                    if(pop === " ") pop = "0"; 
                }

                html += `
                <div class="forecast-card" data-label="+${i*3}HR">
                    <div class="time-badge">${timeStr} èµ·</div>
                    <div class="weather-main">${wx}</div>
                    <div class="details">
                        æº«åº¦: <span class="highlight">${temp}Â°C</span> (é«”æ„Ÿ ${feel}Â°C)<br>
                        é™é›¨æ©Ÿç‡: <span class="highlight">${pop}%</span>
                    </div>
                </div>`;
            }
            displayEl.innerHTML = html;
        }

        function formatTime(date) {
            const d = date.getDate().toString().padStart(2, '0');
            const h = date.getHours().toString().padStart(2, '0');
            const m = date.getMinutes().toString().padStart(2, '0');
            return `${d}æ—¥ ${h}:${m}`;
        }

        init();
    </script>
</body>
</html>
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        h1 {
            font-size: 1.4rem;
            margin: 0;
            text-transform: uppercase;
            text-shadow: 0 0 8px var(--weather-dim); /* è—è‰²å…‰æšˆ */
        }

        .sys-info {
            font-size: 0.7rem;
            color: var(--weather-dim);
            text-align: right;
        }

        /* --- åœ°éœ‡è­¦å ±å€ (æ©˜ç´…è‰²é¢¨æ ¼) --- */
        #quakeArea {
            margin-bottom: 25px;
            display: none; /* é è¨­éš±è—ï¼ŒæŠ“åˆ°è³‡æ–™æ‰é¡¯ç¤º */
        }

        .quake-card {
            border: 2px solid var(--quake-color);
            color: var(--quake-color);
            padding: 15px;
            position: relative;
            background-color: rgba(50, 10, 0, 0.2); /* å¾®ç´…èƒŒæ™¯ */
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.2);
        }

        .quake-card::before {
            content: "[ SEISMIC_ALERT ]";
            position: absolute;
            top: -12px;
            left: 10px;
            background-color: var(--bg-color);
            padding: 0 5px;
            font-weight: bold;
            color: var(--quake-color);
            font-size: 0.8rem;
        }

        .quake-main {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 8px 0;
            text-shadow: 0 0 5px var(--quake-dim);
        }

        .quake-details {
            font-size: 0.95rem;
            border-left: 2px solid var(--quake-dim);
            padding-left: 10px;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* --- å¤©æ°£é¸å–®å€ (è—è‰²é¢¨æ ¼) --- */
        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--weather-dim);
        }

        select {
            background-color: #051a24; /* æ·±è—åº• */
            color: var(--weather-color);
            border: 1px solid var(--weather-color);
            padding: 12px;
            width: 100%;
            font-family: inherit;
            font-size: 1.1rem;
            border-radius: 0;
            outline: none;
        }

        /* --- å¤©æ°£é¡¯ç¤ºå€ --- */
        .forecast-card {
            border: 1px solid var(--weather-dim);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .forecast-card::before {
            content: "[ METEO_DATA ]";
            position: absolute;
            top: -10px;
            left: 10px;
            background-color: var(--bg-color);
            padding: 0 5px;
            font-size: 0.7rem;
            color: var(--weather-dim);
        }

        .time-badge {
            display: inline-block;
            background-color: var(--weather-dim);
            color: #000;
            padding: 2px 6px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .weather-main {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .details {
            font-size: 1rem;
            color: #B2EBF2; /* æ·ºè—è‰²ç´°ç¯€æ–‡å­— */
            margin-top: 8px;
            border-left: 2px solid var(--weather-dim);
            padding-left: 10px;
        }

        .highlight { color: #FFF; font-weight: bold; }

        footer {
            margin-top: 40px;
            font-size: 0.7rem;
            color: var(--weather-dim);
            text-align: center;
            border-top: 1px solid #1A4D66;
            padding-top: 15px;
        }

        /* å‹•ç•«æ•ˆæœ */
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .alert-blink { animation: rapid-blink 1.5s infinite; }
        @keyframes rapid-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <header>
        <h1>> WEATHER_OS_V2</h1>
        <div class="sys-info">
            SYS: ACTIVE<br>
            MODE: MONITOR
        </div>
    </header>

    <div id="quakeArea">
        </div>

    <div class="control-group">
        <label for="citySelect">TARGET SECTOR:</label>
        <select id="citySelect">
            <option value="" disabled selected>INITIALIZING...</option>
        </select>
    </div>

    <div id="displayArea">
        <div class="blink" style="color:var(--weather-dim)">CONNECTING TO CWA SATELLITE...</div>
    </div>

    <footer>
        DATA: CWA OPEN API | AUTH: SECURED<br>
        V2.0 BLUE_THEME + QUAKE_ALERT
    </footer>

    <script>
        // --- è¨­å®šå€ ---
        const API_KEY = 'CWA-30E05081-14C2-4DAE-831E-2796BEDC3575';
        
        // å¤©æ°£é å ± API (36å°æ™‚)
        const WEATHER_API = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${API_KEY}&format=JSON`;
        
        // åœ°éœ‡å ±å‘Š API (é¡¯è‘—æœ‰æ„Ÿåœ°éœ‡ï¼ŒåªæŠ“æœ€æ–°1ç­†)
        const QUAKE_API = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=${API_KEY}&limit=1&format=JSON`;

        // ç¸£å¸‚æ’åº
        const CITY_ORDER = [
            "åŸºéš†å¸‚", "è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", 
            "è‡ºä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "è‡ºå—å¸‚", 
            "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"
        ];

        const selectEl = document.getElementById('citySelect');
        const displayEl = document.getElementById('displayArea');
        const quakeEl = document.getElementById('quakeArea');
        let weatherData = []; 

        // --- ä¸»ç¨‹å¼å•Ÿå‹• ---
        async function init() {
            // åŒæ™‚åŸ·è¡Œï¼šæŠ“å¤©æ°£ & æŠ“åœ°éœ‡
            await Promise.all([fetchWeather(), fetchQuake()]);
        }

        // --- 1. æŠ“å–åœ°éœ‡è³‡æ–™ ---
        async function fetchQuake() {
            try {
                const res = await fetch(QUAKE_API);
                const data = await res.json();
                
                // ç¢ºèªæ˜¯å¦æœ‰åœ°éœ‡è³‡æ–™
                if (data.success === "true" && data.records.Earthquake && data.records.Earthquake.length > 0) {
                    const quake = data.records.Earthquake[0]; // å–å¾—æœ€æ–°ä¸€ç­†
                    renderQuake(quake);
                }
            } catch (err) {
                console.error("Quake Data Error", err);
                // åœ°éœ‡æŠ“å–å¤±æ•—æ™‚ä¸é¡¯ç¤ºä»»ä½•æ±è¥¿ï¼Œä¿æŒä»‹é¢ä¹¾æ·¨
            }
        }

        // --- 2. æŠ“å–å¤©æ°£è³‡æ–™ ---
        async function fetchWeather() {
            try {
                const res = await fetch(WEATHER_API);
                const data = await res.json();

                if (data.success === "true") {
                    weatherData = data.records.location;
                    populateMenu();
                    
                    // è®€å–ä½¿ç”¨è€…ä¸Šæ¬¡é¸æ“‡çš„ç¸£å¸‚
                    const savedLoc = localStorage.getItem('userLocation');
                    const defaultLoc = (savedLoc && weatherData.find(c => c.locationName === savedLoc)) 
                                     ? savedLoc : "è‡ºåŒ—å¸‚";
                    
                    selectEl.value = defaultLoc;
                    renderWeather(defaultLoc);
                }
            } catch (err) {
                console.error(err);
                displayEl.innerHTML = `<div style="border:1px solid red; padding:10px; color:red;">CONNECTION FAILED</div>`;
            }
        }

        // --- é¡¯ç¤ºåœ°éœ‡ (æ©˜ç´…è‰²) ---
        function renderQuake(q) {
            const info = q.EarthquakeInfo;
            const time = new Date(info.OriginTime).toLocaleString('zh-TW', {
                month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            const mag = info.EarthquakeMagnitude.MagnitudeValue;
            const depth = info.FocalDepth;
            const loc = info.Epicenter.Location;

            // æ ¼å¼åŒ– HTML
            quakeEl.innerHTML = `
                <div class="quake-card">
                    <div style="font-size:0.8rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span class="alert-blink">âš ï¸ LATEST REPORT</span>
                        <span>${time}</span>
                    </div>
                    <div class="quake-main">è¦æ¨¡ ${mag} | æ·±åº¦ ${depth}km</div>
                    <div class="quake-details">
                        éœ‡å¤®: ${loc}<br>
                        è³‡è¨Š: ${q.ReportContent.substring(0, 40)}...
                    </div>
                </div>
            `;
            quakeEl.style.display = 'block'; // æœ‰è³‡æ–™æ‰é¡¯ç¤º
        }

        // --- å»ºç«‹é¸å–® ---
        function populateMenu() {
            selectEl.innerHTML = '';
            CITY_ORDER.forEach(cityName => {
                if(weatherData.find(c => c.locationName === cityName)) {
                    const opt = document.createElement('option');
                    opt.value = cityName;
                    opt.innerText = `> ${cityName}`;
                    selectEl.appendChild(opt);
                }
            });
        }

        // --- é¡¯ç¤ºå¤©æ°£ (è—è‰²) ---
        function renderWeather(locationName) {
            localStorage.setItem('userLocation', locationName);
            const locData = weatherData.find(l => l.locationName === locationName);
            if (!locData) return;

            const elements = {};
            locData.weatherElement.forEach(e => { elements[e.elementName] = e.time; });

            let html = '';
            // é¡¯ç¤º 3 å€‹æ™‚æ®µ
            for (let i = 0; i < 3; i++) {
                const startTime = new Date(elements['Wx'][i].startTime);
                const endTime = new Date(elements['Wx'][i].endTime);
                const timeStr = `${formatTime(startTime)} ~ ${formatTime(endTime)}`;
                
                const wx = elements['Wx'][i].parameter.parameterName;
                const pop = elements['PoP'][i].parameter.parameterName;
                const minT = elements['MinT'][i].parameter.parameterName;
                const maxT = elements['MaxT'][i].parameter.parameterName;
                const ci = elements['CI'][i].parameter.parameterName;

                html += `
                <div class="forecast-card">
                    <div class="time-badge">${timeStr}</div>
                    <div class="weather-main">${wx}</div>
                    <div class="details">
                        æ°£æº«: <span class="highlight">${minT}Â°C - ${maxT}Â°C</span><br>
                        é™é›¨æ©Ÿç‡: <span class="highlight">${pop}%</span><br>
                        èˆ’é©åº¦: ${ci}
                    </div>
                </div>`;
            }
            displayEl.innerHTML = html;
        }

        // æ™‚é–“æ ¼å¼å·¥å…·
        function formatTime(date) {
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            const h = date.getHours().toString().padStart(2, '0');
            const min = date.getMinutes().toString().padStart(2, '0');
            return `${m}/${d} ${h}:${min}`;
        }

        // ç›£è½é¸å–®
        selectEl.addEventListener('change', (e) => renderWeather(e.target.value));

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>
