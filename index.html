<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>TERMINAL_WEATHER</title>
    <style>
        /* --- 終端機風格設定 --- */
        :root {
            --bg-color: #000000;       /* 純黑背景 */
            --text-color: #00FF41;     /* 經典螢光綠 */
            --dim-color: #008F11;      /* 暗綠色 */
            --border-color: #00FF41;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Courier New", Courier, monospace; /* 等寬字體 */
            margin: 0;
            padding: 20px;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* 標題區 */
        header {
            border-bottom: 2px dashed var(--text-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.4rem;
            margin: 0;
            text-transform: uppercase;
        }

        .status {
            font-size: 0.8rem;
            color: var(--dim-color);
            margin-top: 5px;
        }

        /* 選單區 */
        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--dim-color);
        }

        select {
            background-color: #111;
            color: var(--text-color);
            border: 1px solid var(--text-color);
            padding: 12px;
            width: 100%;
            font-family: inherit;
            font-size: 1.1rem;
            border-radius: 0; /* 直角 */
            appearance: none; /* 移除原生樣式 */
            outline: none;
        }

        /* 顯示區 */
        .forecast-card {
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        /* 裝飾性標籤 */
        .forecast-card::before {
            content: "[ DATA_PACKET ]";
            position: absolute;
            top: -10px;
            left: 10px;
            background-color: var(--bg-color);
            padding: 0 5px;
            font-size: 0.7rem;
            color: var(--dim-color);
        }

        .time-badge {
            display: inline-block;
            background-color: var(--dim-color);
            color: #000;
            padding: 2px 6px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .weather-main {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .details {
            font-size: 1rem;
            color: #ccc;
            margin-top: 8px;
            border-left: 2px solid var(--dim-color);
            padding-left: 10px;
        }

        .highlight { color: #fff; }

        footer {
            margin-top: 40px;
            font-size: 0.7rem;
            color: var(--dim-color);
            text-align: center;
            border-top: 1px solid #222;
            padding-top: 15px;
        }

        /* 載入動畫 */
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <header>
        <h1>> TW_WEATHER_V1</h1>
        <div class="status">SYSTEM: ONLINE | LOC: TAIWAN</div>
    </header>

    <div class="control-group">
        <label for="citySelect">SELECT TARGET:</label>
        <select id="citySelect">
            <option value="" disabled selected>INITIALIZING...</option>
        </select>
    </div>

    <div id="displayArea">
        <div class="blink">CONNECTING TO CWA SATELLITE...</div>
    </div>

    <footer>
        SOURCE: CWA OPEN DATA API<br>
        UID: ...BEDC3575
    </footer>

    <script>
        // --- 設定區 ---
        const API_KEY = 'CWA-30E05081-14C2-4DAE-831E-2796BEDC3575';
        const API_URL = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${API_KEY}&format=JSON`;

        // 定義縣市顯示順序 (由北到南)
        const CITY_ORDER = [
            "基隆市", "臺北市", "新北市", "桃園市", "新竹市", "新竹縣", "苗栗縣", 
            "臺中市", "彰化縣", "南投縣", "雲林縣", "嘉義市", "嘉義縣", "臺南市", 
            "高雄市", "屏東縣", "宜蘭縣", "花蓮縣", "臺東縣", "澎湖縣", "金門縣", "連江縣"
        ];

        const selectEl = document.getElementById('citySelect');
        const displayEl = document.getElementById('displayArea');
        let weatherData = []; 

        // --- 主程式 ---
        async function init() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (data.success === "true") {
                    weatherData = data.records.location;
                    populateMenu();
                    
                    // 讀取上次選擇的縣市，若無則預設臺北市
                    const savedLoc = localStorage.getItem('userLocation');
                    const defaultLoc = (savedLoc && weatherData.find(c => c.locationName === savedLoc)) 
                                     ? savedLoc : "臺北市";
                    
                    selectEl.value = defaultLoc;
                    renderWeather(defaultLoc);
                } else {
                    throw new Error("API Auth Failed");
                }
            } catch (err) {
                console.error(err);
                // 判斷是否為檔案開啟限制 (CORS/File Protocol)
                let msg = "NETWORK ERROR: 無法連線到氣象署";
                if(window.location.protocol === 'file:') {
                    msg = "BROWSER SECURITY: <br>瀏覽器限制直接開啟檔案連線 API。<br>請參考說明將檔案上傳至網路空間。";
                }
                displayEl.innerHTML = `<div style="color:var(--alert-color); border:1px solid red; padding:10px;">${msg}</div>`;
            }
        }

        // 建立選單 (依自訂順序)
        function populateMenu() {
            selectEl.innerHTML = '';
            CITY_ORDER.forEach(cityName => {
                // 確保 API 裡真的有這個縣市資料
                if(weatherData.find(c => c.locationName === cityName)) {
                    const opt = document.createElement('option');
                    opt.value = cityName;
                    opt.innerText = `> ${cityName}`;
                    selectEl.appendChild(opt);
                }
            });
        }

        // 顯示天氣核心邏輯
        function renderWeather(locationName) {
            // 儲存使用者選擇
            localStorage.setItem('userLocation', locationName);
            
            const locData = weatherData.find(l => l.locationName === locationName);
            if (!locData) return;

            // 整理資料方便讀取 (Wx=現象, PoP=降雨, MinT/MaxT=溫度, CI=舒適度)
            const elements = {};
            locData.weatherElement.forEach(e => {
                elements[e.elementName] = e.time;
            });

            let html = '';

            // 顯示未來 3 個時段
            for (let i = 0; i < 3; i++) {
                const startTime = new Date(elements['Wx'][i].startTime);
                const endTime = new Date(elements['Wx'][i].endTime);
                
                // 時間格式化
                const timeStr = `${formatTime(startTime)} ~ ${formatTime(endTime)}`;
                
                const wx = elements['Wx'][i].parameter.parameterName;
                const pop = elements['PoP'][i].parameter.parameterName;
                const minT = elements['MinT'][i].parameter.parameterName;
                const maxT = elements['MaxT'][i].parameter.parameterName;
                const ci = elements['CI'][i].parameter.parameterName;

                html += `
                <div class="forecast-card">
                    <div class="time-badge">${timeStr}</div>
                    <div class="weather-main">${wx}</div>
                    <div class="details">
                        氣溫: <span class="highlight">${minT}°C - ${maxT}°C</span><br>
                        降雨: <span class="highlight">${pop}%</span><br>
                        體感: ${ci}
                    </div>
                </div>`;
            }
            displayEl.innerHTML = html;
        }

        // 時間格式化工具
        function formatTime(date) {
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            const h = date.getHours().toString().padStart(2, '0');
            const min = date.getMinutes().toString().padStart(2, '0');
            return `${m}/${d} ${h}:${min}`;
        }

        // 監聽選單變更
        selectEl.addEventListener('change', (e) => {
            renderWeather(e.target.value);
        });

        // 啟動
        init();

    </script>
</body>
</html>