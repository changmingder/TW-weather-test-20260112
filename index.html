<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>WEATHER_DASHBOARD_V5</title>
    <style>
        /* --- V5.0: Êà∞ÊÉÖÂÑÄË°®ÊùøÁâà --- */
        :root {
            --bg-color: #000000;
            --weather-color: #00E1FF;
            --weather-dim: #006064;    
            --quake-color: #FF4500;
            --quake-dim: #8B2500;
            --alert-bg: #330000;      
        }

        body {
            background-color: var(--bg-color);
            color: var(--weather-color);
            font-family: "Courier New", Courier, monospace;
            margin: 0; padding: 15px;
            font-size: 16px; line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden; padding-bottom: 80px;
        }

        /* Ë≠¶Â†±ÈñÉÁàçÁâπÊïà */
        body.alarm-active { animation: red-flash 1s infinite; }
        @keyframes red-flash {
            0% { background-color: var(--bg-color); }
            50% { background-color: var(--alert-bg); }
            100% { background-color: var(--bg-color); }
        }

        a { text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }

        header {
            border-bottom: 2px dashed var(--weather-color);
            padding-bottom: 10px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        h1 { font-size: 1.2rem; margin: 0; }
        
        .sys-info { font-size: 0.7rem; color: var(--weather-dim); text-align: right; }
        .monitor-badge {
            display: inline-block; font-size: 0.7rem; padding: 2px 6px; 
            border: 1px solid #333; color: #555; margin-top: 5px; transition: all 0.3s;
        }
        .monitor-active {
            border-color: #00FF00; color: #00FF00;
            box-shadow: 0 0 8px rgba(0,255,0,0.2);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.6;} 100% {opacity:1;} }

        /* ÊåâÈàïÂçÄ */
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn {
            flex: 1; padding: 12px;
            background: #111; color: var(--weather-dim);
            border: 1px dashed var(--weather-dim);
            font-family: inherit; font-size: 0.9rem; cursor: pointer;
            text-transform: uppercase; border-radius: 4px; color: #fff;
        }
        .btn:active { background: #222; transform: translateY(2px); }
        .btn-on { border-color: #00FF00; color: #00FF00; background: rgba(0,20,0,0.3); }

        /* Âú∞ÈúáÂçÄ */
        #quakeArea { 
            margin-bottom: 20px; display: none; cursor: pointer;
            transition: transform 0.1s;
        }
        .quake-card {
            display: block; border: 2px solid var(--quake-color); color: var(--quake-color);
            padding: 15px; position: relative;
            background: rgba(50, 10, 0, 0.2); box-shadow: 0 0 8px rgba(255, 69, 0, 0.2);
        }
        .quake-card:active { transform: scale(0.98); background: rgba(80, 20, 0, 0.3); }
        .quake-card::before {
            content: "[ ‚ö†Ô∏è SEISMIC_ALERT // TAP FOR MAP ]";
            position: absolute; top: -10px; left: 10px;
            background: var(--bg-color); padding: 0 5px; font-weight: bold; font-size: 0.8rem;
            border: 1px solid var(--quake-color);
        }
        .quake-card::after { content: "‚Üó"; position: absolute; top: 5px; right: 10px; font-size: 1.5rem; opacity: 0.5; }
        .quake-main { font-size: 1.3rem; font-weight: bold; margin: 8px 0; }
        .quake-details {
            font-size: 0.95rem; opacity: 0.9; margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed var(--quake-dim); line-height: 1.6; white-space: pre-wrap;
        }
        .alert-blink { animation: rapid-blink 1.5s infinite; }
        @keyframes rapid-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* ÂÑÄË°®ÊùøÂçÄÂüü */
        .dashboard-grid { display: flex; flex-direction: column; gap: 15px; }
        
        .dashboard-label {
            color: var(--weather-dim); font-size: 0.8rem; margin-bottom: 5px;
            border-bottom: 1px solid #333; padding-bottom: 5px;
        }

        .location-section {
            border: 1px solid var(--weather-dim);
            background: rgba(0, 30, 40, 0.2);
            padding: 10px;
        }
        
        .location-header {
            font-size: 1.1rem; border-left: 4px solid var(--weather-color);
            padding-left: 10px; margin-bottom: 10px; color: #fff;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Âç°ÁâáÂÆπÂô® */
        .cards-row {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
        }
        /* Èö±ËóèÊç≤Ëª∏‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .cards-row::-webkit-scrollbar { display: none; }

        .forecast-card {
            min-width: 120px; /* Âõ∫ÂÆöÂØ¨Â∫¶ËÆìÂç°ÁâáÊï¥ÈΩä */
            border: 1px solid var(--weather-dim);
            padding: 10px; position: relative;
            background: rgba(0,0,0,0.5);
            flex-shrink: 0;
        }
        
        .time-badge {
            display: inline-block; background: var(--weather-dim);
            color: #000; padding: 1px 5px; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px;
        }
        .weather-main { font-size: 1.2rem; font-weight: bold; margin: 3px 0; }
        .details {
            font-size: 0.85rem; color: #B2EBF2; margin-top: 5px; padding-left: 5px;
            border-left: 1px solid var(--weather-dim);
        }
        .highlight { color: #FFF; font-weight: bold; }
        
        footer {
            margin-top: 40px; font-size: 0.7rem; color: var(--weather-dim);
            text-align: center; border-top: 1px solid #1A4D66; padding-top: 15px;
        }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .error-msg {
            color: #FF5555; border: 1px solid #FF5555; padding: 10px; 
            font-size: 0.8rem; margin-top: 20px;
        }
    </style>
</head>
<body>

    <header>
        <h1>> WEATHER_OS_V5</h1>
        <div class="sys-info">
            MODE: DASHBOARD<br>
            <span id="monitorStatus" class="monitor-badge">AUTO-SCAN: OFF</span>
        </div>
    </header>

    <div class="btn-group">
        <button id="enableBtn" class="btn" onclick="startMonitor()">üîä ÂïüÂãïÁõ£Êéß</button>
        <button class="btn" onclick="testAlert()">üö® Ê∏¨Ë©¶Ë≠¶Â†±</button>
    </div>

    <a id="quakeArea" class="quake-card" href="#" target="_blank"></a>

    <div class="dashboard-label">MY WATCHLIST (FILTERED)</div>
    <div id="dashboardArea">
        <div class="blink" style="color:var(--weather-dim)">INITIALIZING DASHBOARD...</div>
    </div>

    <footer>
        DATA: CWA API (Optimized)<br>
        UID: ...BEDC3575
    </footer>

    <script>
        const API_KEY = 'CWA-30E05081-14C2-4DAE-831E-2796BEDC3575';

        // ==========================================
        // üõ†Ô∏è „ÄêÈóúÊ≥®Ê∏ÖÂñÆË®≠ÂÆöÂçÄ„ÄëË´ã‰øÆÊîπÈÄôË£°ÔºÅ
        // Ê†ºÂºè: { city: "Á∏£Â∏ÇÂêç", dist: "ÈÑâÈéÆÂçÄÂêç" }
        // ==========================================
        const MY_WATCHLIST = [
            { city: "Ëá∫ÂåóÂ∏Ç", dist: "Â£´ÊûóÂçÄ" },
            { city: "Ëá∫ÂåóÂ∏Ç", dist: "‰ø°Áæ©ÂçÄ" },
            { city: "Êñ∞ÂåóÂ∏Ç", dist: "Ê∑°Ê∞¥ÂçÄ" },
            { city: "Êñ∞ÂåóÂ∏Ç", dist: "ÊùøÊ©ãÂçÄ" },
            { city: "È´òÈõÑÂ∏Ç", dist: "Â∑¶ÁáüÂçÄ" },
            { city: "Ëä±ËìÆÁ∏£", dist: "Ëä±ËìÆÂ∏Ç" }
        ];
        // ==========================================

        const CITY_API_MAP = {
            "ÂÆúËò≠Á∏£": "F-D0047-001", "Ê°ÉÂúíÂ∏Ç": "F-D0047-005", "Êñ∞Á´πÁ∏£": "F-D0047-009",
            "ËãóÊ†óÁ∏£": "F-D0047-013", "ÂΩ∞ÂåñÁ∏£": "F-D0047-017", "ÂçóÊäïÁ∏£": "F-D0047-021",
            "Èõ≤ÊûóÁ∏£": "F-D0047-025", "ÂòâÁæ©Á∏£": "F-D0047-029", "Â±èÊù±Á∏£": "F-D0047-033",
            "Ëá∫Êù±Á∏£": "F-D0047-037", "Ëä±ËìÆÁ∏£": "F-D0047-041", "ÊæéÊπñÁ∏£": "F-D0047-045",
            "Âü∫ÈöÜÂ∏Ç": "F-D0047-049", "Êñ∞Á´πÂ∏Ç": "F-D0047-053", "ÂòâÁæ©Â∏Ç": "F-D0047-057",
            "Ëá∫ÂåóÂ∏Ç": "F-D0047-061", "È´òÈõÑÂ∏Ç": "F-D0047-065", "Êñ∞ÂåóÂ∏Ç": "F-D0047-069",
            "Ëá∫‰∏≠Â∏Ç": "F-D0047-073", "Ëá∫ÂçóÂ∏Ç": "F-D0047-077", "ÈÄ£Ê±üÁ∏£": "F-D0047-081",
            "ÈáëÈñÄÁ∏£": "F-D0047-085"
        };

        // Á≥ªÁµ±ËÆäÊï∏
        let lastQuakeNo = localStorage.getItem('lastQuakeNo') || "";
        let isMonitorActive = false;
        let autoScanTimer = null;
        let weatherResults = {}; // Êö´Â≠òÂ§©Ê∞£Ë≥áÊñô

        // Èü≥ÊïàÁ≥ªÁµ±
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        try { audioCtx = new AudioContext(); } catch(e) { console.warn("Audio not supported"); }

        const dashboardEl = document.getElementById('dashboardArea');
        const quakeEl = document.getElementById('quakeArea');
        const monitorStatus = document.getElementById('monitorStatus');
        const enableBtn = document.getElementById('enableBtn');

        // --- ÂàùÂßãÂåñ ---
        async function init() {
            fetchQuake(false); // ÊäìÂú∞Èúá
            await loadDashboard(); // ÊäìÂ§©Ê∞£
        }

        // --- Ê†∏ÂøÉÔºöÊô∫ÊÖßÂûãÊâπÊ¨°‰∏ãËºâ ---
        async function loadDashboard() {
            dashboardEl.innerHTML = '';
            
            // 1. Â∞áÊ∏ÖÂñÆ‰æùÁÖß„ÄåÁ∏£Â∏Ç„ÄçÂàÜÁµÑ (Ê∏õÂ∞ë API Ë´ãÊ±ÇÊ¨°Êï∏)
            // Ê†ºÂºèËΩâÊèõÁÇ∫: { "Ëá∫ÂåóÂ∏Ç": ["Â£´ÊûóÂçÄ", "‰ø°Áæ©ÂçÄ"], "È´òÈõÑÂ∏Ç": ["Â∑¶ÁáüÂçÄ"] }
            const cityGroups = {};
            MY_WATCHLIST.forEach(item => {
                if(!cityGroups[item.city]) cityGroups[item.city] = [];
                cityGroups[item.city].push(item.dist);
            });

            // 2. Âπ≥Ë°åÁôºÈÄÅ API Ë´ãÊ±Ç (ÊØèÂÄãÁ∏£Â∏ÇÂè™Áôº‰∏ÄÊ¨°)
            const promises = Object.keys(cityGroups).map(async (cityName) => {
                const districts = cityGroups[cityName];
                const dataId = CITY_API_MAP[cityName];
                if(!dataId) return;

                // ‚òÖ ÈóúÈçµÔºö‰ΩøÁî® locationName ÂèÉÊï∏ÈÄ≤Ë°åÈÅéÊøæ
                const locationParam = districts.map(d => encodeURIComponent(d)).join(',');
                const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${dataId}?Authorization=${API_KEY}&format=JSON&elementName=Wx,T,PoP12h,AT&locationName=${locationParam}`;

                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data.success === "true") {
                        // ÂÑ≤Â≠òË≥áÊñô‰ª•‰æøÁ®çÂæåÊ∏≤Êüì
                        data.records.locations[0].location.forEach(loc => {
                            weatherResults[`${cityName}-${loc.locationName}`] = loc;
                        });
                    }
                } catch(e) { console.error(`Failed to fetch ${cityName}`, e); }
            });

            // 3. Á≠âÂæÖÊâÄÊúâË´ãÊ±ÇÂÆåÊàê
            await Promise.all(promises);

            // 4. ‰æùÁÖß‰ΩøÁî®ËÄÖË®≠ÂÆöÁöÑÈ†ÜÂ∫èÊ∏≤ÊüìÂç°Áâá
            renderCards();
        }

        function renderCards() {
            let fullHtml = '';

            MY_WATCHLIST.forEach(item => {
                const key = `${item.city}-${item.dist}`;
                const locData = weatherResults[key];

                if(!locData) {
                    fullHtml += `<div class="location-section" style="border-color:#555; color:#888;">> ${item.city} ${item.dist} (ÁÑ°Ë≥áÊñô/ËÆÄÂèñÂ§±Êïó)</div>`;
                    return;
                }

                const elements = {};
                locData.weatherElement.forEach(e => { elements[e.elementName] = e.time; });

                // Áî¢ÁîüÊ©´ÂêëÂç°Áâá HTML
                let cardsHTML = '';
                const loopLimit = Math.min(3, elements['Wx'].length);

                for(let i=0; i<loopLimit; i++) {
                    const wxTime = elements['Wx'][i];
                    const startTime = new Date(wxTime.startTime);
                    const d = startTime.getDate().toString().padStart(2,'0');
                    const h = startTime.getHours().toString().padStart(2,'0');
                    
                    const wx = elements['Wx'][i].elementValue[0].value;
                    const temp = elements['T'][i].elementValue[0].value;
                    const feel = elements['AT'][i].elementValue[0].value;
                    
                    // ÈôçÈõ®Ê©üÁéá
                    let pop = "0";
                    if (elements['PoP12h']) {
                        const pData = elements['PoP12h'].find(p => {
                            const pStart = new Date(p.startTime);
                            const pEnd = new Date(p.endTime);
                            return (startTime >= pStart && startTime < pEnd) || (pStart >= startTime && pStart < new Date(wxTime.endTime));
                        });
                        pop = pData ? pData.elementValue[0].value : "-";
                        if(pop === " " || pop === "") pop = "0";
                    }

                    cardsHTML += `
                        <div class="forecast-card">
                            <div class="time-badge">${d}Êó• ${h}ÊôÇ</div>
                            <div class="weather-main">${wx}</div>
                            <div class="details">
                                Ê∫´Â∫¶: <span class="highlight">${temp}¬∞C</span><br>
                                È´îÊÑü: ${feel}¬∞C<br>
                                ÈôçÈõ®: <span class="highlight">${pop}%</span>
                            </div>
                        </div>
                    `;
                }

                fullHtml += `
                    <div class="location-section">
                        <div class="location-header">${item.city} ${item.dist}</div>
                        <div class="cards-row">
                            ${cardsHTML}
                        </div>
                    </div>
                `;
            });

            dashboardEl.innerHTML = fullHtml || '<div class="error-msg">NO DATA FOUND</div>';
        }

        // --- Áõ£ÊéßËàáË≠¶Â†±Á≥ªÁµ± ---
        function startMonitor() {
            if(isMonitorActive) return;
            if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            playBeep(0);

            isMonitorActive = true;
            enableBtn.classList.add('btn-on');
            enableBtn.innerText = ">> Áõ£Êéß‰∏≠ (ÊØè60Áßí) <<";
            monitorStatus.classList.add('monitor-active');
            monitorStatus.innerText = "AUTO-SCAN: ACTIVE";

            fetchQuake(true);
            autoScanTimer = setInterval(() => {
                fetchQuake(true);
                // Áõ£ÊéßÊ®°Âºè‰∏ãÔºåÊØè 10 ÂàÜÈêòÊõ¥Êñ∞‰∏ÄÊ¨°Â§©Ê∞£Âç≥ÂèØ
                if(new Date().getMinutes() % 10 === 0) loadDashboard();
            }, 60000);
        }

        function testAlert() {
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            triggerAlert({ EarthquakeMagnitude: { MagnitudeValue: "TEST" }, Epicenter: { Location: "Á≥ªÁµ±Ê∏¨Ë©¶" } }, "Ê∏¨Ë©¶Ë≠¶Â†±Èü≥ÊïàËàáÈÄöÁü•");
        }

        function triggerAlert(info, content) {
            playBeep(1); setTimeout(() => playBeep(1), 600); setTimeout(() => playBeep(1), 1200);
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`‚ö†Ô∏è Âú∞ÈúáË≠¶Â†± M${info.EarthquakeMagnitude.MagnitudeValue}`, {
                    body: `${info.Epicenter.Location}\n${content.substring(0,30)}...`,
                    icon: 'https://www.cwa.gov.tw/favicon.ico'
                });
            }
            document.body.classList.add('alarm-active');
            setTimeout(() => document.body.classList.remove('alarm-active'), 5000);
        }

        function playBeep(vol) {
            if(!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = "square";
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } catch(e) {}
        }

        async function fetchQuake(isMonitorMode) {
            try {
                const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=${API_KEY}&limit=1&format=JSON&t=${new Date().getTime()}`);
                const data = await res.json();
                if (data.records.Earthquake && data.records.Earthquake.length > 0) {
                    const q = data.records.Earthquake[0];
                    const info = q.EarthquakeInfo;
                    const currentNo = q.EarthquakeNo;
                    renderQuakeHTML(q);
                    if (isMonitorMode && lastQuakeNo && currentNo !== lastQuakeNo) triggerAlert(info, q.ReportContent);
                    lastQuakeNo = currentNo;
                    localStorage.setItem('lastQuakeNo', currentNo);
                }
            } catch(e) {}
        }

        function renderQuakeHTML(q) {
            const info = q.EarthquakeInfo;
            const time = new Date(info.OriginTime).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
            quakeEl.href = q.Web || "https://www.cwa.gov.tw/V8/C/E/index.html";
            quakeEl.innerHTML = `
                <div style="font-size:0.8rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                    <span class="alert-blink">‚ö†Ô∏è LATEST REPORT</span>
                    <span>${time}</span>
                </div>
                <div class="quake-main">M${info.EarthquakeMagnitude.MagnitudeValue} | Depth ${info.FocalDepth}km</div>
                <div class="quake-details">${q.ReportContent}</div>`;
            quakeEl.style.display = 'block';
        }

        init();
    </script>
</body>
</html>
